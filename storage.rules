rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isImage() {
      return request.resource != null
        && request.resource.contentType.matches('image/.*');
    }

    function isVideo() {
      return request.resource != null
        && request.resource.contentType.matches('video/.*');
    }

    // -----------------------------------------------------------------------
    // Public, static previews bundled with the app
    // -----------------------------------------------------------------------
    match /previews/{allPaths=**} {
      allow read: if true;
      allow write: if false;
    }

    // -----------------------------------------------------------------------
    // User-generated images (server writes via Admin SDK; keep client access owner-only)
    // -----------------------------------------------------------------------
    match /generated/{uid}/{fileName} {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid) && isImage() && request.resource.size < 20 * 1024 * 1024; // 20MB
    }

    match /image-references/{uid}/{fileName} {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid) && isImage() && request.resource.size < 20 * 1024 * 1024; // 20MB
    }

    // -----------------------------------------------------------------------
    // Video/GIF artifacts (your code stores these under `video-generation/*`)
    // Since these are currently written server-side and served via signed URLs, deny direct SDK access.
    // If you later want authenticated reads, switch `if false` to `if isSignedIn()`.
    // -----------------------------------------------------------------------
    match /video-generation/{fileName} {
      allow read, write: if false;
    }

    // -----------------------------------------------------------------------
    // Default deny
    // -----------------------------------------------------------------------
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}


